<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Details & Location Form</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="form-container">
        <h1 class="form-title">User Registration & Location</h1>

        <form id="userForm">
            <!-- Personal Information -->
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" name="age" min="1" max="120">
                </div>
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" name="gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="address">Address</label>
                <textarea id="address" name="address" placeholder="Enter your full address..."></textarea>
            </div>

            <div class="form-group">
                <label for="specialRequests">Special Requests / Additional Information</label>
                <textarea id="specialRequests" name="specialRequests"
                    placeholder="Please describe any special requirements, preferences, or additional information you'd like us to know..."></textarea>
            </div>

            <!-- Location Tracking Section -->
            <div class="location-section">
                <h3 class="location-title">üìç GPS Location Tracking</h3>
                <p style="margin-bottom: 15px; color: #666;">We can automatically detect your exact current location and city to provide better service.</p>

                <button type="button" id="getLocationBtn" class="location-btn">
                    Get My Exact Location
                </button>

                <div id="locationStatus"></div>

                <div id="locationDisplay" class="location-display" style="display: none;">
                    <h4>Your Exact Location Details:</h4>
                    <div class="location-info">
                        <div class="location-item">
                            <strong>Latitude:</strong>
                            <span id="latitude">-</span>
                        </div>
                        <div class="location-item">
                            <strong>Longitude:</strong>
                            <span id="longitude">-</span>
                        </div>
                        <div class="location-item">
                            <strong>Accuracy:</strong>
                            <span id="accuracy">-</span>
                        </div>
                        <div class="location-item">
                            <strong>Timestamp:</strong>
                            <span id="timestamp">-</span>
                        </div>
                    </div>
                    
                    <div class="city-info">
                        <h4>üèôÔ∏è Exact City Information:</h4>
                        <div id="cityDetails">Loading city details...</div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <strong>Complete Address:</strong>
                        <div id="approximateAddress">Loading exact address...</div>
                    </div>
                </div>
            </div>

            <button type="submit" class="submit-btn">Submit Form</button>
        </form>
    </div>

    <script>
        let currentLocation = null;
        let exactLocationData = null;

        // Get location button functionality
        document.getElementById('getLocationBtn').addEventListener('click', function () {
            const btn = this;
            const statusDiv = document.getElementById('locationStatus');

            btn.disabled = true;
            btn.textContent = 'Getting Exact Location...';

            statusDiv.innerHTML = '<div class="status-message loading">üîÑ Requesting high-precision location access...</div>';

            if (!navigator.geolocation) {
                statusDiv.innerHTML = '<div class="status-message error">‚ùå Geolocation is not supported by this browser.</div>';
                btn.disabled = false;
                btn.textContent = 'Get My Exact Location';
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 45000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date(position.timestamp)
                    };

                    displayLocation(currentLocation);
                    getExactLocationDetails(currentLocation.latitude, currentLocation.longitude);

                    statusDiv.innerHTML = '<div class="status-message success">‚úÖ Exact location detected successfully!</div>';
                    btn.textContent = 'Exact Location Detected ‚úì';
                    btn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                },
                function (error) {
                    let errorMessage = '';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "Location access denied by user.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "Location request timed out.";
                            break;
                        default:
                            errorMessage = "An unknown error occurred.";
                            break;
                    }

                    statusDiv.innerHTML = `<div class="status-message error">‚ùå Error: ${errorMessage}</div>`;
                    btn.disabled = false;
                    btn.textContent = 'Try Again';
                }
            );
        });

        function displayLocation(location) {
            document.getElementById('latitude').textContent = location.latitude.toFixed(8);
            document.getElementById('longitude').textContent = location.longitude.toFixed(8);
            document.getElementById('accuracy').textContent = `¬±${Math.round(location.accuracy)} meters`;
            document.getElementById('timestamp').textContent = location.timestamp.toLocaleString();

            document.getElementById('locationDisplay').style.display = 'block';
        }

        function getExactLocationDetails(lat, lng) {
            const addressDiv = document.getElementById('approximateAddress');
            const cityDiv = document.getElementById('cityDetails');
            
            addressDiv.textContent = 'Getting exact address...';
            cityDiv.textContent = 'Determining exact city...';
            
            // Replace with your actual API key
            const apiKey = 'AIzaSyBWz5umc3lrE4xUdfPviXY4monWFqX3edw';
            
            // Enhanced Google Geocoding API request for maximum precision
            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&result_type=street_address|premise|subpremise|establishment&location_type=ROOFTOP|RANGE_INTERPOLATED&language=en`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('Google Geocoding Response:', data);
                    
                    if (data.status === 'OK' && data.results && data.results.length > 0) {
                        processLocationResults(data.results);
                    } else if (data.status === 'ZERO_RESULTS') {
                        // Try with broader result types if no exact results
                        getBroaderLocationResults(lat, lng, apiKey);
                    } else {
                        throw new Error(`Geocoding failed: ${data.status}`);
                    }
                })
                .catch(error => {
                    console.error('Primary geocoding error:', error);
                    // Fallback to broader search
                    getBroaderLocationResults(lat, lng, apiKey);
                });
        }

        function getBroaderLocationResults(lat, lng, apiKey) {
            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${apiKey}&language=en`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Broader Geocoding Response:', data);
                    
                    if (data.status === 'OK' && data.results && data.results.length > 0) {
                        processLocationResults(data.results);
                    } else {
                        fallbackToCoordinates(lat, lng);
                    }
                })
                .catch(error => {
                    console.error('Broader geocoding error:', error);
                    fallbackToCoordinates(lat, lng);
                });
        }

        function processLocationResults(results) {
            const addressDiv = document.getElementById('approximateAddress');
            const cityDiv = document.getElementById('cityDetails');
            
            // Find the most precise result
            const preciseResult = results[0];
            exactLocationData = {
                fullAddress: preciseResult.formatted_address,
                components: preciseResult.address_components,
                placeId: preciseResult.place_id,
                types: preciseResult.types
            };

            // Extract city information from address components
            let cityInfo = extractCityInformation(preciseResult.address_components);
            
            // Display city information
            let cityDisplay = '';
            if (cityInfo.locality) {
                cityDisplay += `<strong>City/Town:</strong> ${cityInfo.locality}<br>`;
            }
            if (cityInfo.sublocality) {
                cityDisplay += `<strong>Area/Locality:</strong> ${cityInfo.sublocality}<br>`;
            }
            if (cityInfo.district) {
                cityDisplay += `<strong>District:</strong> ${cityInfo.district}<br>`;
            }
            if (cityInfo.state) {
                cityDisplay += `<strong>State:</strong> ${cityInfo.state}<br>`;
            }
            if (cityInfo.country) {
                cityDisplay += `<strong>Country:</strong> ${cityInfo.country}<br>`;
            }
            if (cityInfo.pincode) {
                cityDisplay += `<strong>PIN Code:</strong> ${cityInfo.pincode}`;
            }

            cityDiv.innerHTML = cityDisplay || 'City information not available';
            addressDiv.innerHTML = preciseResult.formatted_address;

            // Update the form's address field
            const addressInput = document.getElementById('address');
            if (addressInput) {
                const firstName = document.getElementById('firstName')?.value || '';
                const lastName = document.getElementById('lastName')?.value || '';
                const userName = firstName || lastName ? `${firstName} ${lastName}`.trim() : '';
                
                addressInput.value = userName 
                    ? `${userName}\n${preciseResult.formatted_address}`
                    : preciseResult.formatted_address;
            }

            console.log('Processed Location Data:', {
                address: preciseResult.formatted_address,
                cityInfo: cityInfo,
                coordinates: currentLocation
            });
        }

        function extractCityInformation(components) {
            const cityInfo = {};
            
            components.forEach(component => {
                const types = component.types;
                
                if (types.includes('locality')) {
                    cityInfo.locality = component.long_name;
                } else if (types.includes('sublocality') || types.includes('sublocality_level_1')) {
                    cityInfo.sublocality = component.long_name;
                } else if (types.includes('administrative_area_level_3')) {
                    cityInfo.district = component.long_name;
                } else if (types.includes('administrative_area_level_1')) {
                    cityInfo.state = component.long_name;
                } else if (types.includes('country')) {
                    cityInfo.country = component.long_name;
                } else if (types.includes('postal_code')) {
                    cityInfo.pincode = component.long_name;
                }
            });
            
            return cityInfo;
        }

        function fallbackToCoordinates(lat, lng) {
            const addressDiv = document.getElementById('approximateAddress');
            const cityDiv = document.getElementById('cityDetails');
            
            addressDiv.innerHTML = `<em>Exact address not available</em><br>Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            cityDiv.innerHTML = 'City information could not be determined from coordinates';
            
            console.log('Fallback to coordinates:', { lat, lng });
        }

        // Form submission
        document.getElementById('userForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {};

            // Collect form data
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            // Add location data if available
            if (currentLocation) {
                data.location = currentLocation;
                data.exactLocationData = exactLocationData;
                data.locationCaptured = true;
            } else {
                data.locationCaptured = false;
            }

            // Display the collected data
            console.log('Complete Form Data with Exact Location:', data);

            // Show success message
            const statusDiv = document.getElementById('locationStatus');
            statusDiv.innerHTML = '<div class="status-message success">üéâ Form submitted successfully with exact location data! Check the console for complete details.</div>';

            // In a real application, send to server:
            // fetch('/api/submit-form', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(data)
            // });
        });
    </script>
</body>

</html>